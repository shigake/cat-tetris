import{u as De,r as d,h as be,P as ye,i as je,S as we,n as M,o as Ce,a as Te,R as V,p as Fe,d as He,j as e,q as Se,H as Pe,T as Ae,N as ke,t as Ne,A as ze,m as Ie}from"./index-21dd9244.js";function qe({mode:a,aiDifficulty:h,ai1Difficulty:p,ai2Difficulty:m,onExit:f}){var H,S,z,W,q,B,E,K,U,Y,J,Q,X,Z,ee,te,re,se,ae,ie,ne,le,ce,oe,de,pe,xe,ue;const{t:c}=De(),[i,w]=d.useState(null),[n,P]=d.useState(null),[u,L]=d.useState(null),[R,$]=d.useState(0),[_,D]=d.useState(0),x=d.useRef({p1:null,p2:null,ai:null,ai1:null,ai2:null}),y=d.useRef(0),v=d.useRef(null),b=d.useRef(null);d.useEffect(()=>{const l=new be(new ye,new je,null,new we),t=new be(new ye,new je,null,new we);let o=null,r=null,s=null;if(a==="vsAI")try{o=new M,o.setDifficulty(h||"medium"),h==="expert"&&(t.score._fixedLevel=1)}catch{}else a==="aiVsAI"&&(r=new M,r.setDifficulty(p||"expert"),r.setVisualMode(!0),s=new M,s.setDifficulty(m||"expert"),s.setVisualMode(!0),(p||"expert")==="expert"&&(l.score._fixedLevel=1),(m||"expert")==="expert"&&(t.score._fixedLevel=1));return l.initializeGame(),l.isPlaying=!0,t.initializeGame(),t.isPlaying=!0,a==="vsAI"&&h==="expert"?(t._lockDelayMax=2e3,t._lockDelayMaxResets=50):a==="aiVsAI"&&((p||"expert")==="expert"&&(l._lockDelayMax=2e3,l._lockDelayMaxResets=50),(m||"expert")==="expert"&&(t._lockDelayMax=2e3,t._lockDelayMaxResets=50)),x.current={p1:l,p2:t,ai:o,ai1:r,ai2:s},w(l.getGameState()),P(t.getGameState()),()=>{v.current&&cancelAnimationFrame(v.current)}},[a,h,p,m]),d.useEffect(()=>{const l=t=>{var ge,ve;y.current||(y.current=t);const o=t-y.current;y.current=t;const{p1:r,p2:s,ai:j,ai1:k,ai2:N}=x.current;if(!r||!s){v.current=requestAnimationFrame(l);return}if(r.gameOver||s.gameOver){b.current||(r.gameOver&&!s.gameOver?b.current="player2":!r.gameOver&&s.gameOver?b.current="player1":b.current=(((ge=r.score)==null?void 0:ge.points)||0)>=(((ve=s.score)==null?void 0:ve.points)||0)?"player1":"player2",L(b.current)),r.gameOver||(r.gameOver=!0,r._markDirty()),s.gameOver||(s.gameOver=!0,s._markDirty()),r.isDirty&&(w(r.getGameState()),r.clearDirty()),s.isDirty&&(P(s.getGameState()),s.clearDirty());return}r.isPaused||r.updateGame(o),s.isPaused||s.updateGame(o);const me=r.consumeAttack();me>0&&!s.gameOver&&s.receiveGarbage(me);const fe=s.consumeAttack();fe>0&&!r.gameOver&&r.receiveGarbage(fe);const I=(G,g)=>{if(!(!G||g.gameOver))try{const _e=a==="aiVsAI"?3:G._isExpert?2:1;for(let he=0;he<_e;he++){const O=G.decideNextMove(g.getGameState());if(!O)break;switch(O.action){case"left":g.movePiece("left");break;case"right":g.movePiece("right");break;case"rotate":g.rotatePiece();break;case"down":g.movePiece("down");break;case"drop":g.hardDrop();break;case"hold":g.holdPiece();break}if(O.action==="drop")break}}catch{}};a==="aiVsAI"?(I(k,r),I(N,s)):a==="vsAI"&&I(j,s),r.isDirty&&(w(r.getGameState()),$(r.pendingGarbage),r.clearDirty()),s.isDirty&&(P(s.getGameState()),D(s.pendingGarbage),s.clearDirty()),v.current=requestAnimationFrame(l)};return v.current=requestAnimationFrame(l),()=>{v.current&&cancelAnimationFrame(v.current)}},[a]),d.useEffect(()=>{if(u||a==="aiVsAI")return;const l=Ce(Te()),t=o=>{const r=x.current.p1;if(!r||r.gameOver)return;const s=l[o.key];if(s)switch(s){case"moveLeft":o.preventDefault(),r.movePiece("left");break;case"moveRight":o.preventDefault(),r.movePiece("right");break;case"moveDown":o.preventDefault(),r.movePiece("down");break;case"rotate":o.preventDefault(),r.rotatePiece();break;case"rotateLeft":r.rotatePiece("left");break;case"hold":r.holdPiece();break;case"hardDrop":o.preventDefault(),r.hardDrop();break}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[u,a]);const Oe=V.useMemo(()=>{const l={backToMenu:f,togglePause:()=>{},isGameOver:()=>{const t=x.current.p1;return(t==null?void 0:t.gameOver)??!0}};return u||a==="aiVsAI"?l:{...l,movePiece:t=>{const o=x.current.p1;o&&!o.gameOver&&o.movePiece(t)},rotatePiece:()=>{const t=x.current.p1;t&&!t.gameOver&&t.rotatePiece()},rotatePieceLeft:()=>{const t=x.current.p1;t&&!t.gameOver&&t.rotatePiece("left")},hardDrop:()=>{const t=x.current.p1;t&&!t.gameOver&&t.hardDrop()},holdPiece:()=>{const t=x.current.p1;t&&!t.gameOver&&t.holdPiece()}}},[u,a,f]),{isGamepadActive:A,controllerCount:Me,processGamepadInput:C,getGamepadInfo:Ve}=Fe(Oe);d.useEffect(()=>{if(!A)return;const l=setInterval(()=>C(),16);return()=>clearInterval(l)},[A,C]);const T=d.useCallback(()=>{var j,k,N;const{p1:l,p2:t,ai:o,ai1:r,ai2:s}=x.current;l&&(l.initializeGame(),l.isPlaying=!0),t&&(t.initializeGame(),t.isPlaying=!0),o&&((j=o.reset)==null||j.call(o)),r&&((k=r.reset)==null||k.call(r)),s&&((N=s.reset)==null||N.call(s)),b.current=null,y.current=0,L(null),$(0),D(0),l&&w(l.getGameState()),t&&P(t.getGameState())},[]),{selectedIndex:F}=He({itemCount:2,onConfirm:l=>{l===0?T():f()},onBack:f,active:!!u,wrap:!0}),Le=V.useMemo(()=>{var l;if(!(i!=null&&i.currentPiece)||i!=null&&i.gameOver)return null;try{return(l=x.current.p1)==null?void 0:l.getDropPreview()}catch{return null}},[(S=(H=i==null?void 0:i.currentPiece)==null?void 0:H.position)==null?void 0:S.x,(W=(z=i==null?void 0:i.currentPiece)==null?void 0:z.position)==null?void 0:W.y,(q=i==null?void 0:i.currentPiece)==null?void 0:q.type,(B=i==null?void 0:i.currentPiece)==null?void 0:B.rotationState]),Re=V.useMemo(()=>{var l;if(!(n!=null&&n.currentPiece)||n!=null&&n.gameOver)return null;try{return(l=x.current.p2)==null?void 0:l.getDropPreview()}catch{return null}},[(K=(E=n==null?void 0:n.currentPiece)==null?void 0:E.position)==null?void 0:K.x,(Y=(U=n==null?void 0:n.currentPiece)==null?void 0:U.position)==null?void 0:Y.y,(J=n==null?void 0:n.currentPiece)==null?void 0:J.type,(Q=n==null?void 0:n.currentPiece)==null?void 0:Q.rotationState]);return!i||!n?e.jsx("div",{className:"h-screen flex items-center justify-center bg-gradient-to-br from-purple-900 to-blue-900",children:e.jsx("div",{className:"text-white text-2xl",children:c("multiplayer.loading")})}):e.jsxs("div",{className:"h-screen flex flex-col items-center bg-gradient-to-br from-purple-900 to-blue-900 p-2 overflow-hidden",children:[A&&e.jsx(Se,{isConnected:A,controllerCount:Me,gamepadInfo:Ve()}),e.jsxs("div",{className:"flex justify-between items-center w-full max-w-5xl mb-2",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-white",children:c(a==="aiVsAI"?"multiplayer.aiVsAiTitle":a==="vsAI"?"multiplayer.vsAiTitle":"multiplayer.localTitle")}),e.jsx("button",{onClick:f,className:"bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg transition-colors text-sm font-bold",children:c("common.back")})]}),e.jsxs("div",{className:"multiplayer-boards flex gap-1 sm:gap-4 items-start justify-center",children:[e.jsxs("div",{className:"flex flex-col items-center min-w-0",children:[e.jsx("div",{className:"bg-blue-600 text-white px-2 sm:px-4 py-0.5 sm:py-1 rounded-t-lg font-bold text-xs sm:text-base truncate max-w-full",children:a==="aiVsAI"?`ðŸ¤– AI1 (${c(`multiplayer.diff.${p}`)})`:c(a==="vsAI"?"multiplayer.you":"multiplayer.p1")}),e.jsxs("div",{className:"bg-black/40 p-1 sm:p-2 rounded-b-lg",children:[e.jsxs("div",{className:"flex gap-1 sm:gap-2",children:[e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(Pe,{heldPiece:i.heldPiece,canHold:i.canHold}),a!=="aiVsAI"&&e.jsx("div",{className:"text-white/60 text-[10px] leading-tight whitespace-pre-line",children:c("multiplayer.controlsP1")})]}),e.jsx(Ae,{board:i.board,currentPiece:i.currentPiece,dropPreview:Le,gameOver:i.gameOver}),R>0&&e.jsx(Ge,{count:R}),e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(ke,{pieces:i.nextPieces||[]}),e.jsx(Ne,{score:((X=i.score)==null?void 0:X.points)||0,level:((Z=i.score)==null?void 0:Z.level)||1,lines:((ee=i.score)==null?void 0:ee.lines)||0,combo:((te=i.score)==null?void 0:te.combo)||0})]})]}),e.jsxs("div",{className:"sm:hidden flex justify-between text-[9px] text-white/70 mt-1 px-0.5 font-mono",children:[e.jsx("span",{children:(((re=i.score)==null?void 0:re.points)||0).toLocaleString()}),e.jsxs("span",{children:["Lv",((se=i.score)==null?void 0:se.level)||1]}),e.jsxs("span",{children:["L",((ae=i.score)==null?void 0:ae.lines)||0]})]})]})]}),e.jsx("div",{className:"flex items-center justify-center self-center",children:e.jsx("div",{className:"bg-yellow-500 text-black font-bold text-sm sm:text-3xl px-2 sm:px-4 py-1 sm:py-2 rounded-full shadow-2xl animate-pulse",children:"VS"})}),e.jsxs("div",{className:"flex flex-col items-center min-w-0",children:[e.jsx("div",{className:"bg-red-600 text-white px-2 sm:px-4 py-0.5 sm:py-1 rounded-t-lg font-bold text-xs sm:text-base truncate max-w-full",children:a==="aiVsAI"?`ðŸ¤– AI2 (${c(`multiplayer.diff.${m}`)})`:a==="vsAI"?`ðŸ¤– AI (${c(`multiplayer.diff.${h}`)})`:c("multiplayer.p2")}),e.jsxs("div",{className:"bg-black/40 p-1 sm:p-2 rounded-b-lg",children:[e.jsxs("div",{className:"flex gap-1 sm:gap-2",children:[e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(Pe,{heldPiece:n.heldPiece,canHold:n.canHold}),a==="1v1"&&e.jsx("div",{className:"text-white/60 text-[10px] leading-tight whitespace-pre-line",children:c("multiplayer.controlsP2")})]}),e.jsx(Ae,{board:n.board,currentPiece:n.currentPiece,dropPreview:Re,gameOver:n.gameOver}),_>0&&e.jsx(Ge,{count:_}),e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(ke,{pieces:n.nextPieces||[]}),e.jsx(Ne,{score:((ie=n.score)==null?void 0:ie.points)||0,level:((ne=n.score)==null?void 0:ne.level)||1,lines:((le=n.score)==null?void 0:le.lines)||0,combo:((ce=n.score)==null?void 0:ce.combo)||0})]})]}),e.jsxs("div",{className:"sm:hidden flex justify-between text-[9px] text-white/70 mt-1 px-0.5 font-mono",children:[e.jsx("span",{children:(((oe=n.score)==null?void 0:oe.points)||0).toLocaleString()}),e.jsxs("span",{children:["Lv",((de=n.score)==null?void 0:de.level)||1]}),e.jsxs("span",{children:["L",((pe=n.score)==null?void 0:pe.lines)||0]})]})]})]})]}),e.jsx(ze,{children:u&&e.jsx(Ie.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/90 flex items-center justify-center z-50",children:e.jsxs(Ie.div,{initial:{scale:.8,y:50},animate:{scale:1,y:0},className:"bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl p-12 text-center",children:[e.jsx("div",{className:"text-8xl mb-4",children:u==="player1"||a==="aiVsAI"?"ðŸ†":"ðŸ’€"}),e.jsx("h2",{className:"text-5xl font-bold text-white mb-4",children:c(a==="aiVsAI"?u==="player1"?"multiplayer.ai1Won":"multiplayer.ai2Won":u==="player1"?"multiplayer.victory":"multiplayer.defeat")}),e.jsx("p",{className:"text-2xl text-white/80 mb-8",children:a==="aiVsAI"?`${u==="player1"?p==null?void 0:p.toUpperCase():m==null?void 0:m.toUpperCase()} ${c("multiplayer.isSuperior")}`:c(u==="player1"?a==="vsAI"?"multiplayer.youBeatAI":"multiplayer.player1Won":a==="vsAI"?"multiplayer.aiBeatYou":"multiplayer.player2Won")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-8 text-white",children:[e.jsxs("div",{className:"bg-black/30 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm opacity-60",children:a==="aiVsAI"?`AI1 (${c(`multiplayer.diff.${p}`)})`:c("multiplayer.player1")}),e.jsx("div",{className:"text-3xl font-bold",children:(((xe=i.score)==null?void 0:xe.points)||0).toLocaleString()})]}),e.jsxs("div",{className:"bg-black/30 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm opacity-60",children:a==="aiVsAI"?`AI2 (${c(`multiplayer.diff.${m}`)})`:a==="vsAI"?"AI":c("multiplayer.player2")}),e.jsx("div",{className:"text-3xl font-bold",children:(((ue=n.score)==null?void 0:ue.points)||0).toLocaleString()})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:T,className:`bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold text-xl transition-colors ${F===0?"ring-2 ring-yellow-400 ring-offset-2 ring-offset-orange-600":""}`,children:c("multiplayer.playAgain")}),e.jsx("button",{onClick:f,className:`bg-gray-700 hover:bg-gray-800 text-white px-8 py-3 rounded-lg font-bold text-xl transition-colors ${F===1?"ring-2 ring-yellow-400 ring-offset-2 ring-offset-orange-600":""}`,children:c("multiplayer.backToMenu")})]})]})})})]})}function Ge({count:a}){const p=Math.min(a,20);return e.jsx("div",{className:"flex flex-col-reverse justify-end w-3 rounded overflow-hidden",style:{height:"calc(var(--cell) * 22 + 22px)"},children:Array.from({length:p},(m,f)=>e.jsx("div",{className:"w-full",style:{height:`${100/20}%`,backgroundColor:a>8?"#ef4444":a>4?"#f59e0b":"#ef4444",opacity:.7+f/p*.3}},f))})}export{qe as default};
