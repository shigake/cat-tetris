import{u as $e,r as x,d as be,P as we,e as je,S as Pe,f as V,R as M,g as Ee,b as Te,j as e,h as Fe,H as Ae,T as ye,N as Ne,i as ke,A as Se,m as Ie}from"./index-84426587.js";function ze({mode:t,aiDifficulty:v,ai1Difficulty:p,ai2Difficulty:d,onExit:g}){var S,U,z,H,W,B,q,X,D,Y,Z,J,K,Q,ee,re,te,se,ae,ne,le,ie,ce,oe,pe,xe,de,me;const{t:o}=$e(),[s,P]=x.useState(null),[a,A]=x.useState(null),[u,R]=x.useState(null),[L,C]=x.useState(0),[_,$]=x.useState(0),m=x.useRef({p1:null,p2:null,ai:null,ai1:null,ai2:null}),w=x.useRef(0),f=x.useRef(null),b=x.useRef(null);x.useEffect(()=>{const n=new be(new we,new je,null,new Pe),r=new be(new we,new je,null,new Pe);let c=null,i=null,l=null;if(t==="vsAI")try{c=new V,c.setDifficulty(v||"medium"),v==="expert"&&(r.score._fixedLevel=1)}catch{}else t==="aiVsAI"&&(i=new V,i.setDifficulty(p||"expert"),i.setVisualMode(!0),l=new V,l.setDifficulty(d||"expert"),l.setVisualMode(!0),(p||"expert")==="expert"&&(n.score._fixedLevel=1),(d||"expert")==="expert"&&(r.score._fixedLevel=1));return n.initializeGame(),n.isPlaying=!0,r.initializeGame(),r.isPlaying=!0,t==="vsAI"&&v==="expert"?(r._lockDelayMax=2e3,r._lockDelayMaxResets=50):t==="aiVsAI"&&((p||"expert")==="expert"&&(n._lockDelayMax=2e3,n._lockDelayMaxResets=50),(d||"expert")==="expert"&&(r._lockDelayMax=2e3,r._lockDelayMaxResets=50)),m.current={p1:n,p2:r,ai:c,ai1:i,ai2:l},P(n.getGameState()),A(r.getGameState()),()=>{f.current&&cancelAnimationFrame(f.current)}},[t,v,p,d]),x.useEffect(()=>{const n=r=>{var ve,he;w.current||(w.current=r);const c=r-w.current;w.current=r;const{p1:i,p2:l,ai:j,ai1:N,ai2:k}=m.current;if(!i||!l){f.current=requestAnimationFrame(n);return}if(i.gameOver||l.gameOver){b.current||(i.gameOver&&!l.gameOver?b.current="player2":!i.gameOver&&l.gameOver?b.current="player1":b.current=(((ve=i.score)==null?void 0:ve.points)||0)>=(((he=l.score)==null?void 0:he.points)||0)?"player1":"player2",R(b.current)),i.gameOver||(i.gameOver=!0,i._markDirty()),l.gameOver||(l.gameOver=!0,l._markDirty()),i.isDirty&&(P(i.getGameState()),i.clearDirty()),l.isDirty&&(A(l.getGameState()),l.clearDirty());return}i.isPaused||i.updateGame(c),l.isPaused||l.updateGame(c);const ue=i.consumeAttack();ue>0&&!l.gameOver&&l.receiveGarbage(ue);const ge=l.consumeAttack();ge>0&&!i.gameOver&&i.receiveGarbage(ge);const I=(G,h)=>{if(!(!G||h.gameOver))try{const _e=t==="aiVsAI"?3:G._isExpert?2:1;for(let fe=0;fe<_e;fe++){const O=G.decideNextMove(h.getGameState());if(!O)break;switch(O.action){case"left":h.movePiece("left");break;case"right":h.movePiece("right");break;case"rotate":h.rotatePiece();break;case"down":h.movePiece("down");break;case"drop":h.hardDrop();break;case"hold":h.holdPiece();break}if(O.action==="drop")break}}catch{}};t==="aiVsAI"?(I(N,i),I(k,l)):t==="vsAI"&&I(j,l),i.isDirty&&(P(i.getGameState()),C(i.pendingGarbage),i.clearDirty()),l.isDirty&&(A(l.getGameState()),$(l.pendingGarbage),l.clearDirty()),f.current=requestAnimationFrame(n)};return f.current=requestAnimationFrame(n),()=>{f.current&&cancelAnimationFrame(f.current)}},[t]),x.useEffect(()=>{if(u||t==="aiVsAI")return;const n=r=>{const c=m.current.p1;if(!(!c||c.gameOver))switch(r.key){case"ArrowLeft":r.preventDefault(),c.movePiece("left");break;case"ArrowRight":r.preventDefault(),c.movePiece("right");break;case"ArrowDown":r.preventDefault(),c.movePiece("down");break;case"ArrowUp":r.preventDefault(),c.rotatePiece();break;case"z":case"Z":c.rotatePiece("left");break;case"c":case"C":case"Shift":c.holdPiece();break;case" ":r.preventDefault(),c.hardDrop();break}};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[u,t]);const Oe=M.useMemo(()=>{const n={backToMenu:g,togglePause:()=>{},isGameOver:()=>{const r=m.current.p1;return(r==null?void 0:r.gameOver)??!0}};return u||t==="aiVsAI"?n:{...n,movePiece:r=>{const c=m.current.p1;c&&!c.gameOver&&c.movePiece(r)},rotatePiece:()=>{const r=m.current.p1;r&&!r.gameOver&&r.rotatePiece()},rotatePieceLeft:()=>{const r=m.current.p1;r&&!r.gameOver&&r.rotatePiece("left")},hardDrop:()=>{const r=m.current.p1;r&&!r.gameOver&&r.hardDrop()},holdPiece:()=>{const r=m.current.p1;r&&!r.gameOver&&r.holdPiece()}}},[u,t,g]),{isGamepadActive:y,controllerCount:Ve,processGamepadInput:E,getGamepadInfo:Me}=Ee(Oe);x.useEffect(()=>{if(!y)return;const n=setInterval(()=>E(),16);return()=>clearInterval(n)},[y,E]);const T=x.useCallback(()=>{var j,N,k;const{p1:n,p2:r,ai:c,ai1:i,ai2:l}=m.current;n&&(n.initializeGame(),n.isPlaying=!0),r&&(r.initializeGame(),r.isPlaying=!0),c&&((j=c.reset)==null||j.call(c)),i&&((N=i.reset)==null||N.call(i)),l&&((k=l.reset)==null||k.call(l)),b.current=null,w.current=0,R(null),C(0),$(0),n&&P(n.getGameState()),r&&A(r.getGameState())},[]),{selectedIndex:F}=Te({itemCount:2,onConfirm:n=>{n===0?T():g()},onBack:g,active:!!u,wrap:!0}),Re=M.useMemo(()=>{var n;if(!(s!=null&&s.currentPiece)||s!=null&&s.gameOver)return null;try{return(n=m.current.p1)==null?void 0:n.getDropPreview()}catch{return null}},[(U=(S=s==null?void 0:s.currentPiece)==null?void 0:S.position)==null?void 0:U.x,(H=(z=s==null?void 0:s.currentPiece)==null?void 0:z.position)==null?void 0:H.y,(W=s==null?void 0:s.currentPiece)==null?void 0:W.type,(B=s==null?void 0:s.currentPiece)==null?void 0:B.rotationState]),Le=M.useMemo(()=>{var n;if(!(a!=null&&a.currentPiece)||a!=null&&a.gameOver)return null;try{return(n=m.current.p2)==null?void 0:n.getDropPreview()}catch{return null}},[(X=(q=a==null?void 0:a.currentPiece)==null?void 0:q.position)==null?void 0:X.x,(Y=(D=a==null?void 0:a.currentPiece)==null?void 0:D.position)==null?void 0:Y.y,(Z=a==null?void 0:a.currentPiece)==null?void 0:Z.type,(J=a==null?void 0:a.currentPiece)==null?void 0:J.rotationState]);return!s||!a?e.jsx("div",{className:"h-screen flex items-center justify-center bg-gradient-to-br from-purple-900 to-blue-900",children:e.jsx("div",{className:"text-white text-2xl",children:o("multiplayer.loading")})}):e.jsxs("div",{className:"h-screen flex flex-col items-center bg-gradient-to-br from-purple-900 to-blue-900 p-2 overflow-hidden",children:[y&&e.jsx(Fe,{isConnected:y,controllerCount:Ve,gamepadInfo:Me()}),e.jsxs("div",{className:"flex justify-between items-center w-full max-w-5xl mb-2",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-white",children:o(t==="aiVsAI"?"multiplayer.aiVsAiTitle":t==="vsAI"?"multiplayer.vsAiTitle":"multiplayer.localTitle")}),e.jsx("button",{onClick:g,className:"bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg transition-colors text-sm font-bold",children:o("common.back")})]}),e.jsxs("div",{className:"multiplayer-boards flex gap-1 sm:gap-4 items-start justify-center",children:[e.jsxs("div",{className:"flex flex-col items-center min-w-0",children:[e.jsx("div",{className:"bg-blue-600 text-white px-2 sm:px-4 py-0.5 sm:py-1 rounded-t-lg font-bold text-xs sm:text-base truncate max-w-full",children:t==="aiVsAI"?`ðŸ¤– IA1 (${(p==null?void 0:p.toUpperCase())||"EXPERT"})`:o(t==="vsAI"?"multiplayer.you":"multiplayer.p1")}),e.jsxs("div",{className:"bg-black/40 p-1 sm:p-2 rounded-b-lg",children:[e.jsxs("div",{className:"flex gap-1 sm:gap-2",children:[e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(Ae,{heldPiece:s.heldPiece,canHold:s.canHold}),t!=="aiVsAI"&&e.jsx("div",{className:"text-white/60 text-[10px] leading-tight whitespace-pre-line",children:o("multiplayer.controlsP1")})]}),e.jsx(ye,{board:s.board,currentPiece:s.currentPiece,dropPreview:Re,gameOver:s.gameOver}),L>0&&e.jsx(Ge,{count:L}),e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(Ne,{pieces:s.nextPieces||[]}),e.jsx(ke,{score:((K=s.score)==null?void 0:K.points)||0,level:((Q=s.score)==null?void 0:Q.level)||1,lines:((ee=s.score)==null?void 0:ee.lines)||0,combo:((re=s.score)==null?void 0:re.combo)||0})]})]}),e.jsxs("div",{className:"sm:hidden flex justify-between text-[9px] text-white/70 mt-1 px-0.5 font-mono",children:[e.jsx("span",{children:(((te=s.score)==null?void 0:te.points)||0).toLocaleString()}),e.jsxs("span",{children:["Lv",((se=s.score)==null?void 0:se.level)||1]}),e.jsxs("span",{children:["L",((ae=s.score)==null?void 0:ae.lines)||0]})]})]})]}),e.jsx("div",{className:"flex items-center justify-center self-center",children:e.jsx("div",{className:"bg-yellow-500 text-black font-bold text-sm sm:text-3xl px-2 sm:px-4 py-1 sm:py-2 rounded-full shadow-2xl animate-pulse",children:"VS"})}),e.jsxs("div",{className:"flex flex-col items-center min-w-0",children:[e.jsx("div",{className:"bg-red-600 text-white px-2 sm:px-4 py-0.5 sm:py-1 rounded-t-lg font-bold text-xs sm:text-base truncate max-w-full",children:t==="aiVsAI"?`ðŸ¤– IA2 (${(d==null?void 0:d.toUpperCase())||"EXPERT"})`:t==="vsAI"?`ðŸ¤– IA (${(v==null?void 0:v.toUpperCase())||"MEDIUM"})`:o("multiplayer.p2")}),e.jsxs("div",{className:"bg-black/40 p-1 sm:p-2 rounded-b-lg",children:[e.jsxs("div",{className:"flex gap-1 sm:gap-2",children:[e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(Ae,{heldPiece:a.heldPiece,canHold:a.canHold}),t==="1v1"&&e.jsx("div",{className:"text-white/60 text-[10px] leading-tight whitespace-pre-line",children:o("multiplayer.controlsP2")})]}),e.jsx(ye,{board:a.board,currentPiece:a.currentPiece,dropPreview:Le,gameOver:a.gameOver}),_>0&&e.jsx(Ge,{count:_}),e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(Ne,{pieces:a.nextPieces||[]}),e.jsx(ke,{score:((ne=a.score)==null?void 0:ne.points)||0,level:((le=a.score)==null?void 0:le.level)||1,lines:((ie=a.score)==null?void 0:ie.lines)||0,combo:((ce=a.score)==null?void 0:ce.combo)||0})]})]}),e.jsxs("div",{className:"sm:hidden flex justify-between text-[9px] text-white/70 mt-1 px-0.5 font-mono",children:[e.jsx("span",{children:(((oe=a.score)==null?void 0:oe.points)||0).toLocaleString()}),e.jsxs("span",{children:["Lv",((pe=a.score)==null?void 0:pe.level)||1]}),e.jsxs("span",{children:["L",((xe=a.score)==null?void 0:xe.lines)||0]})]})]})]})]}),e.jsx(Se,{children:u&&e.jsx(Ie.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/90 flex items-center justify-center z-50",children:e.jsxs(Ie.div,{initial:{scale:.8,y:50},animate:{scale:1,y:0},className:"bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl p-12 text-center",children:[e.jsx("div",{className:"text-8xl mb-4",children:u==="player1"||t==="aiVsAI"?"ðŸ†":"ðŸ’€"}),e.jsx("h2",{className:"text-5xl font-bold text-white mb-4",children:o(t==="aiVsAI"?u==="player1"?"multiplayer.ai1Won":"multiplayer.ai2Won":u==="player1"?"multiplayer.victory":"multiplayer.defeat")}),e.jsx("p",{className:"text-2xl text-white/80 mb-8",children:t==="aiVsAI"?`${u==="player1"?p==null?void 0:p.toUpperCase():d==null?void 0:d.toUpperCase()} ${o("multiplayer.isSuperior")}`:o(u==="player1"?t==="vsAI"?"multiplayer.youBeatAI":"multiplayer.player1Won":t==="vsAI"?"multiplayer.aiBeatYou":"multiplayer.player2Won")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-8 text-white",children:[e.jsxs("div",{className:"bg-black/30 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm opacity-60",children:t==="aiVsAI"?`IA1 (${p})`:"Player 1"}),e.jsx("div",{className:"text-3xl font-bold",children:(((de=s.score)==null?void 0:de.points)||0).toLocaleString()})]}),e.jsxs("div",{className:"bg-black/30 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm opacity-60",children:t==="aiVsAI"?`IA2 (${d})`:t==="vsAI"?"IA":"Player 2"}),e.jsx("div",{className:"text-3xl font-bold",children:(((me=a.score)==null?void 0:me.points)||0).toLocaleString()})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:T,className:`bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold text-xl transition-colors ${F===0?"ring-2 ring-yellow-400 ring-offset-2 ring-offset-orange-600":""}`,children:o("multiplayer.playAgain")}),e.jsx("button",{onClick:g,className:`bg-gray-700 hover:bg-gray-800 text-white px-8 py-3 rounded-lg font-bold text-xl transition-colors ${F===1?"ring-2 ring-yellow-400 ring-offset-2 ring-offset-orange-600":""}`,children:o("multiplayer.backToMenu")})]})]})})})]})}function Ge({count:t}){const p=Math.min(t,20);return e.jsx("div",{className:"flex flex-col-reverse justify-end w-3 rounded overflow-hidden",style:{height:"calc(var(--cell) * 22 + 22px)"},children:Array.from({length:p},(d,g)=>e.jsx("div",{className:"w-full",style:{height:`${100/20}%`,backgroundColor:t>8?"#ef4444":t>4?"#f59e0b":"#ef4444",opacity:.7+g/p*.3}},g))})}export{ze as default};
