import{u as Te,r as d,h as be,P as je,i as Pe,S as we,n as M,o as $e,a as Ee,R as V,p as Fe,d as He,j as e,q as Se,H as ye,T as Ae,N as ke,t as Ne,A as Ue,m as Ie}from"./index-d5856a23.js";function We({mode:a,aiDifficulty:v,ai1Difficulty:p,ai2Difficulty:x,onExit:g}){var H,S,U,z,W,q,B,D,K,X,Y,J,Q,Z,ee,te,re,se,ae,ne,ie,le,ce,oe,pe,de,xe,me;const{t:o}=Te(),[n,w]=d.useState(null),[i,y]=d.useState(null),[u,R]=d.useState(null),[L,C]=d.useState(0),[_,T]=d.useState(0),m=d.useRef({p1:null,p2:null,ai:null,ai1:null,ai2:null}),j=d.useRef(0),f=d.useRef(null),b=d.useRef(null);d.useEffect(()=>{const l=new be(new je,new Pe,null,new we),t=new be(new je,new Pe,null,new we);let c=null,r=null,s=null;if(a==="vsAI")try{c=new M,c.setDifficulty(v||"medium"),v==="expert"&&(t.score._fixedLevel=1)}catch{}else a==="aiVsAI"&&(r=new M,r.setDifficulty(p||"expert"),r.setVisualMode(!0),s=new M,s.setDifficulty(x||"expert"),s.setVisualMode(!0),(p||"expert")==="expert"&&(l.score._fixedLevel=1),(x||"expert")==="expert"&&(t.score._fixedLevel=1));return l.initializeGame(),l.isPlaying=!0,t.initializeGame(),t.isPlaying=!0,a==="vsAI"&&v==="expert"?(t._lockDelayMax=2e3,t._lockDelayMaxResets=50):a==="aiVsAI"&&((p||"expert")==="expert"&&(l._lockDelayMax=2e3,l._lockDelayMaxResets=50),(x||"expert")==="expert"&&(t._lockDelayMax=2e3,t._lockDelayMaxResets=50)),m.current={p1:l,p2:t,ai:c,ai1:r,ai2:s},w(l.getGameState()),y(t.getGameState()),()=>{f.current&&cancelAnimationFrame(f.current)}},[a,v,p,x]),d.useEffect(()=>{const l=t=>{var ve,he;j.current||(j.current=t);const c=t-j.current;j.current=t;const{p1:r,p2:s,ai:P,ai1:k,ai2:N}=m.current;if(!r||!s){f.current=requestAnimationFrame(l);return}if(r.gameOver||s.gameOver){b.current||(r.gameOver&&!s.gameOver?b.current="player2":!r.gameOver&&s.gameOver?b.current="player1":b.current=(((ve=r.score)==null?void 0:ve.points)||0)>=(((he=s.score)==null?void 0:he.points)||0)?"player1":"player2",R(b.current)),r.gameOver||(r.gameOver=!0,r._markDirty()),s.gameOver||(s.gameOver=!0,s._markDirty()),r.isDirty&&(w(r.getGameState()),r.clearDirty()),s.isDirty&&(y(s.getGameState()),s.clearDirty());return}r.isPaused||r.updateGame(c),s.isPaused||s.updateGame(c);const ue=r.consumeAttack();ue>0&&!s.gameOver&&s.receiveGarbage(ue);const ge=s.consumeAttack();ge>0&&!r.gameOver&&r.receiveGarbage(ge);const I=(G,h)=>{if(!(!G||h.gameOver))try{const _e=a==="aiVsAI"?3:G._isExpert?2:1;for(let fe=0;fe<_e;fe++){const O=G.decideNextMove(h.getGameState());if(!O)break;switch(O.action){case"left":h.movePiece("left");break;case"right":h.movePiece("right");break;case"rotate":h.rotatePiece();break;case"down":h.movePiece("down");break;case"drop":h.hardDrop();break;case"hold":h.holdPiece();break}if(O.action==="drop")break}}catch{}};a==="aiVsAI"?(I(k,r),I(N,s)):a==="vsAI"&&I(P,s),r.isDirty&&(w(r.getGameState()),C(r.pendingGarbage),r.clearDirty()),s.isDirty&&(y(s.getGameState()),T(s.pendingGarbage),s.clearDirty()),f.current=requestAnimationFrame(l)};return f.current=requestAnimationFrame(l),()=>{f.current&&cancelAnimationFrame(f.current)}},[a]),d.useEffect(()=>{if(u||a==="aiVsAI")return;const l=$e(Ee()),t=c=>{const r=m.current.p1;if(!r||r.gameOver)return;const s=l[c.key];if(s)switch(s){case"moveLeft":c.preventDefault(),r.movePiece("left");break;case"moveRight":c.preventDefault(),r.movePiece("right");break;case"moveDown":c.preventDefault(),r.movePiece("down");break;case"rotate":c.preventDefault(),r.rotatePiece();break;case"rotateLeft":r.rotatePiece("left");break;case"hold":r.holdPiece();break;case"hardDrop":c.preventDefault(),r.hardDrop();break}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[u,a]);const Oe=V.useMemo(()=>{const l={backToMenu:g,togglePause:()=>{},isGameOver:()=>{const t=m.current.p1;return(t==null?void 0:t.gameOver)??!0}};return u||a==="aiVsAI"?l:{...l,movePiece:t=>{const c=m.current.p1;c&&!c.gameOver&&c.movePiece(t)},rotatePiece:()=>{const t=m.current.p1;t&&!t.gameOver&&t.rotatePiece()},rotatePieceLeft:()=>{const t=m.current.p1;t&&!t.gameOver&&t.rotatePiece("left")},hardDrop:()=>{const t=m.current.p1;t&&!t.gameOver&&t.hardDrop()},holdPiece:()=>{const t=m.current.p1;t&&!t.gameOver&&t.holdPiece()}}},[u,a,g]),{isGamepadActive:A,controllerCount:Me,processGamepadInput:$,getGamepadInfo:Ve}=Fe(Oe);d.useEffect(()=>{if(!A)return;const l=setInterval(()=>$(),16);return()=>clearInterval(l)},[A,$]);const E=d.useCallback(()=>{var P,k,N;const{p1:l,p2:t,ai:c,ai1:r,ai2:s}=m.current;l&&(l.initializeGame(),l.isPlaying=!0),t&&(t.initializeGame(),t.isPlaying=!0),c&&((P=c.reset)==null||P.call(c)),r&&((k=r.reset)==null||k.call(r)),s&&((N=s.reset)==null||N.call(s)),b.current=null,j.current=0,R(null),C(0),T(0),l&&w(l.getGameState()),t&&y(t.getGameState())},[]),{selectedIndex:F}=He({itemCount:2,onConfirm:l=>{l===0?E():g()},onBack:g,active:!!u,wrap:!0}),Re=V.useMemo(()=>{var l;if(!(n!=null&&n.currentPiece)||n!=null&&n.gameOver)return null;try{return(l=m.current.p1)==null?void 0:l.getDropPreview()}catch{return null}},[(S=(H=n==null?void 0:n.currentPiece)==null?void 0:H.position)==null?void 0:S.x,(z=(U=n==null?void 0:n.currentPiece)==null?void 0:U.position)==null?void 0:z.y,(W=n==null?void 0:n.currentPiece)==null?void 0:W.type,(q=n==null?void 0:n.currentPiece)==null?void 0:q.rotationState]),Le=V.useMemo(()=>{var l;if(!(i!=null&&i.currentPiece)||i!=null&&i.gameOver)return null;try{return(l=m.current.p2)==null?void 0:l.getDropPreview()}catch{return null}},[(D=(B=i==null?void 0:i.currentPiece)==null?void 0:B.position)==null?void 0:D.x,(X=(K=i==null?void 0:i.currentPiece)==null?void 0:K.position)==null?void 0:X.y,(Y=i==null?void 0:i.currentPiece)==null?void 0:Y.type,(J=i==null?void 0:i.currentPiece)==null?void 0:J.rotationState]);return!n||!i?e.jsx("div",{className:"h-screen flex items-center justify-center bg-gradient-to-br from-purple-900 to-blue-900",children:e.jsx("div",{className:"text-white text-2xl",children:o("multiplayer.loading")})}):e.jsxs("div",{className:"h-screen flex flex-col items-center bg-gradient-to-br from-purple-900 to-blue-900 p-2 overflow-hidden",children:[A&&e.jsx(Se,{isConnected:A,controllerCount:Me,gamepadInfo:Ve()}),e.jsxs("div",{className:"flex justify-between items-center w-full max-w-5xl mb-2",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-white",children:o(a==="aiVsAI"?"multiplayer.aiVsAiTitle":a==="vsAI"?"multiplayer.vsAiTitle":"multiplayer.localTitle")}),e.jsx("button",{onClick:g,className:"bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded-lg transition-colors text-sm font-bold",children:o("common.back")})]}),e.jsxs("div",{className:"multiplayer-boards flex gap-1 sm:gap-4 items-start justify-center",children:[e.jsxs("div",{className:"flex flex-col items-center min-w-0",children:[e.jsx("div",{className:"bg-blue-600 text-white px-2 sm:px-4 py-0.5 sm:py-1 rounded-t-lg font-bold text-xs sm:text-base truncate max-w-full",children:a==="aiVsAI"?`ðŸ¤– IA1 (${(p==null?void 0:p.toUpperCase())||"EXPERT"})`:o(a==="vsAI"?"multiplayer.you":"multiplayer.p1")}),e.jsxs("div",{className:"bg-black/40 p-1 sm:p-2 rounded-b-lg",children:[e.jsxs("div",{className:"flex gap-1 sm:gap-2",children:[e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(ye,{heldPiece:n.heldPiece,canHold:n.canHold}),a!=="aiVsAI"&&e.jsx("div",{className:"text-white/60 text-[10px] leading-tight whitespace-pre-line",children:o("multiplayer.controlsP1")})]}),e.jsx(Ae,{board:n.board,currentPiece:n.currentPiece,dropPreview:Re,gameOver:n.gameOver}),L>0&&e.jsx(Ge,{count:L}),e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(ke,{pieces:n.nextPieces||[]}),e.jsx(Ne,{score:((Q=n.score)==null?void 0:Q.points)||0,level:((Z=n.score)==null?void 0:Z.level)||1,lines:((ee=n.score)==null?void 0:ee.lines)||0,combo:((te=n.score)==null?void 0:te.combo)||0})]})]}),e.jsxs("div",{className:"sm:hidden flex justify-between text-[9px] text-white/70 mt-1 px-0.5 font-mono",children:[e.jsx("span",{children:(((re=n.score)==null?void 0:re.points)||0).toLocaleString()}),e.jsxs("span",{children:["Lv",((se=n.score)==null?void 0:se.level)||1]}),e.jsxs("span",{children:["L",((ae=n.score)==null?void 0:ae.lines)||0]})]})]})]}),e.jsx("div",{className:"flex items-center justify-center self-center",children:e.jsx("div",{className:"bg-yellow-500 text-black font-bold text-sm sm:text-3xl px-2 sm:px-4 py-1 sm:py-2 rounded-full shadow-2xl animate-pulse",children:"VS"})}),e.jsxs("div",{className:"flex flex-col items-center min-w-0",children:[e.jsx("div",{className:"bg-red-600 text-white px-2 sm:px-4 py-0.5 sm:py-1 rounded-t-lg font-bold text-xs sm:text-base truncate max-w-full",children:a==="aiVsAI"?`ðŸ¤– IA2 (${(x==null?void 0:x.toUpperCase())||"EXPERT"})`:a==="vsAI"?`ðŸ¤– IA (${(v==null?void 0:v.toUpperCase())||"MEDIUM"})`:o("multiplayer.p2")}),e.jsxs("div",{className:"bg-black/40 p-1 sm:p-2 rounded-b-lg",children:[e.jsxs("div",{className:"flex gap-1 sm:gap-2",children:[e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(ye,{heldPiece:i.heldPiece,canHold:i.canHold}),a==="1v1"&&e.jsx("div",{className:"text-white/60 text-[10px] leading-tight whitespace-pre-line",children:o("multiplayer.controlsP2")})]}),e.jsx(Ae,{board:i.board,currentPiece:i.currentPiece,dropPreview:Le,gameOver:i.gameOver}),_>0&&e.jsx(Ge,{count:_}),e.jsxs("div",{className:"hidden sm:flex flex-col gap-2",children:[e.jsx(ke,{pieces:i.nextPieces||[]}),e.jsx(Ne,{score:((ne=i.score)==null?void 0:ne.points)||0,level:((ie=i.score)==null?void 0:ie.level)||1,lines:((le=i.score)==null?void 0:le.lines)||0,combo:((ce=i.score)==null?void 0:ce.combo)||0})]})]}),e.jsxs("div",{className:"sm:hidden flex justify-between text-[9px] text-white/70 mt-1 px-0.5 font-mono",children:[e.jsx("span",{children:(((oe=i.score)==null?void 0:oe.points)||0).toLocaleString()}),e.jsxs("span",{children:["Lv",((pe=i.score)==null?void 0:pe.level)||1]}),e.jsxs("span",{children:["L",((de=i.score)==null?void 0:de.lines)||0]})]})]})]})]}),e.jsx(Ue,{children:u&&e.jsx(Ie.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 bg-black/90 flex items-center justify-center z-50",children:e.jsxs(Ie.div,{initial:{scale:.8,y:50},animate:{scale:1,y:0},className:"bg-gradient-to-br from-yellow-500 to-orange-600 rounded-2xl p-12 text-center",children:[e.jsx("div",{className:"text-8xl mb-4",children:u==="player1"||a==="aiVsAI"?"ðŸ†":"ðŸ’€"}),e.jsx("h2",{className:"text-5xl font-bold text-white mb-4",children:o(a==="aiVsAI"?u==="player1"?"multiplayer.ai1Won":"multiplayer.ai2Won":u==="player1"?"multiplayer.victory":"multiplayer.defeat")}),e.jsx("p",{className:"text-2xl text-white/80 mb-8",children:a==="aiVsAI"?`${u==="player1"?p==null?void 0:p.toUpperCase():x==null?void 0:x.toUpperCase()} ${o("multiplayer.isSuperior")}`:o(u==="player1"?a==="vsAI"?"multiplayer.youBeatAI":"multiplayer.player1Won":a==="vsAI"?"multiplayer.aiBeatYou":"multiplayer.player2Won")}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-8 text-white",children:[e.jsxs("div",{className:"bg-black/30 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm opacity-60",children:a==="aiVsAI"?`IA1 (${p})`:"Player 1"}),e.jsx("div",{className:"text-3xl font-bold",children:(((xe=n.score)==null?void 0:xe.points)||0).toLocaleString()})]}),e.jsxs("div",{className:"bg-black/30 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm opacity-60",children:a==="aiVsAI"?`IA2 (${x})`:a==="vsAI"?"IA":"Player 2"}),e.jsx("div",{className:"text-3xl font-bold",children:(((me=i.score)==null?void 0:me.points)||0).toLocaleString()})]})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("button",{onClick:E,className:`bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold text-xl transition-colors ${F===0?"ring-2 ring-yellow-400 ring-offset-2 ring-offset-orange-600":""}`,children:o("multiplayer.playAgain")}),e.jsx("button",{onClick:g,className:`bg-gray-700 hover:bg-gray-800 text-white px-8 py-3 rounded-lg font-bold text-xl transition-colors ${F===1?"ring-2 ring-yellow-400 ring-offset-2 ring-offset-orange-600":""}`,children:o("multiplayer.backToMenu")})]})]})})})]})}function Ge({count:a}){const p=Math.min(a,20);return e.jsx("div",{className:"flex flex-col-reverse justify-end w-3 rounded overflow-hidden",style:{height:"calc(var(--cell) * 22 + 22px)"},children:Array.from({length:p},(x,g)=>e.jsx("div",{className:"w-full",style:{height:`${100/20}%`,backgroundColor:a>8?"#ef4444":a>4?"#f59e0b":"#ef4444",opacity:.7+g/p*.3}},g))})}export{We as default};
